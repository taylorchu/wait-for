version: 2
jobs:
  build:
    docker:
      - image: cimg/go:1.19
    steps:
      - checkout
      - run: go install honnef.co/go/tools/cmd/staticcheck@latest
      - run: staticcheck -checks all,-ST1000 ./...
      - run: go test -p 1 -v -cover -coverprofile=c.out -race ./...
      - run: go tool cover -func=c.out
      - setup_remote_docker:
          version: 20.10.14
      - run: |
          [[ -z "$CIRCLE_TAG" ]] && exit 0
          [[ "$CIRCLE_BRANCH" == master ]] || exit 0
          docker build -t DOCKERHUB_IMAGE:$CIRCLE_TAG --build-args VERSION=$CIRCLE_SHA1 .
          echo $DOCKERHUB_PASS | docker login -u $DOCKERHUB_USER --password-stdin
          docker push DOCKERHUB_IMAGE:$CIRCLE_TAG
